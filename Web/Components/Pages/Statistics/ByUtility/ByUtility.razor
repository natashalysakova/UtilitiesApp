@using ApexCharts;

@if (Checks is null)
{
    return;
}

@if (_utilityList is not null)
{
    <MudSelect Variant="Variant.Outlined" T="UtilityGroupViewModel" @bind-Value="@_utilitySelected" SelectedValuesChanged="ReloadChart">
        @foreach (var item in _utilityList)
        {
            <MudSelectItem Value="@item.Key">@item.Key.Name</MudSelectItem>
        }
    </MudSelect>

    if (_utilitySelected is not null)
    {
        @switch (_utilityList[_utilitySelected])
        {
            case TariffType.Meters:
                <ByUtilityMeters Checks="@Checks" SelectedUtility="@_utilitySelected"></ByUtilityMeters>
                break;
            case TariffType.Volume:
                <ByUtilityVolume Checks="@Checks" SelectedUtility="@_utilitySelected"></ByUtilityVolume>
                break;
            case TariffType.NotFixedPayment:
                <ByUtilityNotFixed Checks="@Checks" SelectedUtility="@_utilitySelected"></ByUtilityNotFixed>
                break;
        }
    }

@*     @foreach (var item in utilityList)
    {
        var url = $"/home/{Checks.First().Home.Id}/stats/{item.Key.Id}";
        <MudLink Href="@url">@item.Key.Name</MudLink>
    } *@
}


@code {
    [Parameter, EditorRequired]
    public IEnumerable<CheckViewDto>? Checks { get; set; }

    private UtilityGroupViewModel? _utilitySelected;
    private Dictionary<UtilityGroupViewModel, TariffType> _utilityList = new Dictionary<UtilityGroupViewModel, TariffType>();

    private void ReloadChart()
    {
        StateHasChanged();
    }

    protected override void OnInitialized()
    {
    }

    protected override void OnParametersSet()
    {
        if (Checks != null)
        {
            _utilityList = Checks
                .SelectMany(x => x.Records)
                .Where(x => x.Tariff.TariffType is TariffType.Meters or TariffType.Volume or TariffType.NotFixedPayment)
                .DistinctBy(x => x.Tariff.UtilityGroupId)
                .ToDictionary(x => new UtilityGroupViewModel() { Id = x.Tariff.UtilityGroupId, Name = x.Tariff.UtilityGroupName }, x => x.Tariff.TariffType);

            if (_utilityList.Any())
            {
                _utilitySelected = _utilityList.First().Key;
            }
        }
    }
}
